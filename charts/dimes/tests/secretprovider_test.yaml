# SPDX-FileCopyrightText: Copyright Â© 2025 The Dymes project authors
#
# SPDX-License-Identifier: Apache-2.0

suite: test secret provider
templates:
  - secretprovider.yaml
tests:
  - it: should render no secret providers by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should render multiple secret providers if multiple are configured
    set:
      secretproviders:
        hsm-cu-user-password:
          objects:
            - objectName: "CUSigningService"
              objectType: "secretsmanager"
          secretObjects:
            - secretName: hsm-password
              type: Opaque
              data:
                - objectName: CUSigningService
                  key: password
        hsm-client-ca-cert:
          objects:
            - objectName: "/cluster-cvlpxov3tya/CodeBuild/CUST_CERTIFICATE"
              objectType: "ssmparameter"
              objectAlias: "cacert.pem"
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: SecretProviderClass
      - equal:
          path: spec.provider
          value: aws

  - it: should render objects as a string
    set:
      secretproviders:
        hsm-client-ca-cert:
          objects:
            - objectName: "/cluster-cvlpxov3tya/CodeBuild/CUST_CERTIFICATE"
              objectType: "ssmparameter"
              objectAlias: "cacert.pem"
    asserts:
      - isKind:
          of: SecretProviderClass
      - equal:
          path: metadata.name
          value: hsm-client-ca-cert
      - equal:
          path: spec.parameters.objects
          value: |
            - objectAlias: cacert.pem
              objectName: /cluster-cvlpxov3tya/CodeBuild/CUST_CERTIFICATE
              objectType: ssmparameter

  - it: should add secretObjects
    set:
      secretproviders:
        hsm-cu-user-password:
          objects:
            - objectName: "CUSigningService"
              objectType: "secretsmanager"
          secretObjects:
            - secretName: hsm-password
              type: Opaque
              data:
                - objectName: CUSigningService
                  key: password
    asserts:
      - isKind:
          of: SecretProviderClass
      - equal:
          path: metadata.name
          value: hsm-cu-user-password
      - equal:
          path: spec.parameters.objects
          value: |
            - objectName: CUSigningService
              objectType: secretsmanager
      - contains:
          path: spec.secretObjects
          content:
            secretName: hsm-password
            type: Opaque
            data:
              - objectName: CUSigningService
                key: password
